<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thought Shift AI Chat</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }

    .container {
      display: flex;
      height: 90vh;
    }

    .sidebar {
      width: 25%;
      padding: 1rem;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }

    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .message {
      margin: 0.25rem 0;
      padding: 0.25rem 0.5rem;
      max-width: 70%;
    }

    .message.user {
      align-self: flex-end;
      text-align: right;
    }

    .message.bot {
      align-self: flex-start;
      text-align: left;
    }

    .chat-input {
      display: flex;
      gap: 0.25rem;
    }

    .chat-input input {
      flex: 1;
    }

    .questionnaire-form {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- Sidebar: Previous questionnaire responses -->
  <div class="sidebar">
    <h4>Questionnaire History</h4>
    <ul>
      {% for q in questionnaire_responses %}
        <li>{{ q.category }} â€” {{ q.created_at|date:"Y-m-d H:i" }}</li>
      {% empty %}
        <li>No previous questionnaires.</li>
      {% endfor %}
    </ul>
  </div>

  <div class="main">

    {% if not latest_questionnaire %}
    <!-- NEW: Questionnaire dropdown at the top -->
    <form method="post" class="questionnaire-form">
      {% csrf_token %}
      <label for="category">Select Cognitive Distortion Category:</label>
      <select name="category" id="category" required>
        <option value="" disabled selected>-- Choose a category --</option>
        <option value="Self-Critical / Achievement-Related Distortions">
          Self-Critical / Achievement-Related
        </option>
        <option value="Social / Interpersonal Distortions">
          Social / Interpersonal
        </option>
        <option value="Task / Productivity-Related Distortions">
          Task / Productivity
        </option>
        <option value="Mood / Motivation Distortions">
          Mood / Motivation
        </option>
      </select>
      <button type="submit" name="create_questionnaire">Start</button>
    </form>
    {% endif %}

    {% if latest_questionnaire %}
    <!-- Chat section only visible after a questionnaire is created -->
    <div class="chat-box" id="chatBox">
      {% for msg in chat_messages %}
        <div class="message {{ msg.role }}">
          {{ msg.content|linebreaksbr }}
        </div>
      {% empty %}
        <p>No messages yet.</p>
      {% endfor %}
    </div>

    <form method="post">
      {% csrf_token %}
      <div class="chat-input">
        <input type="text" name="message" placeholder="Type your message..." required>
        <button type="submit">Send</button>
      </div>
    </form>
    {% endif %}

  </div>
</div>

<script>
  const chatBox = document.getElementById("chatBox");
  if (chatBox) {
    chatBox.scrollTop = chatBox.scrollHeight;
  }
</script>

</body>
</html>